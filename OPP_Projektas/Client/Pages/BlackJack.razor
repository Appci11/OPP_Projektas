@page "/blackjack"
@using OPP_Projektas.Shared.Models.BlackJack
@using OPP_Projektas.Shared.Models.Styles
@using OPP_Projektas.Shared.Models.Cards
@inject NavigationManager NavigationManager

<PageTitle>BlackJack</PageTitle>
<div style="display:flex">
    <div>
        <h1>BlackJack</h1>

        <div>
            <p role="status">Balance: @PlayerBalance</p>
            <p role="status">@Message</p>
        </div>

        <table hidden="@_hideTable">
            <tr>
                @foreach (var card in DealerCards)
                {
                    <td style="@CardsStyle.RenderCardBorder()">@card.Suit.ToString() | @card.FaceValue.ToString()</td>
                }
                @if (DealerCards.Count > 0)
                {
                    <td>@DealerCards.Sum(c => c.ScoreValue)</td>
                }
            </tr>
            <tr>
                @foreach (var card in PlayerCards)
                {
                    <td style="@CardsStyle.RenderCardBorder()">@card.Suit.ToString() | @card.FaceValue.ToString()</td>
                }
                @if(PlayerCards.Count > 0)
                {
                    <td>@PlayerCards.Sum(c => c.ScoreValue)</td>
                }
            </tr>
        </table>
    </div>
</div>

<button class="btn btn-primary" hidden="@_hideJoinButton" @onclick="JoinTable">Join table</button>
<div hidden="@_hideStartGameBtn">
    <input @bind="BetSize" type="number" aria-label="Bet size:"/>
    <button class="btn btn-primary" @onclick="Bet">Place Bet</button>
</div>
<div hidden="@_hidePlayButtons">
    <button disabled="@_loading" class="btn btn-primary" @onclick="DrawCard">Hit me!</button>
    <button disabled="@_loading" class="btn btn-secondary" @onclick="PlayerStands">Stand</button>
</div>
<hr/>
<button class="btn btn-info" @onclick="ChangeCardsStyle">Changed slots style</button>

@code {
    private IStyle _style = new DefaultStyle();
    private static HubConnection? _hubConnection;
    private Guid _tableId = Guid.NewGuid();
    private Guid _playerId = Guid.NewGuid();
    private bool _hideJoinButton;
    private bool _hideStartGameBtn = true;
    private bool _hidePlayButtons = true;
    private bool _loading;
    private string StartBtnLabel = "Start game";
    private bool _initialPhaseDone;
    private bool _hideTable;
    private bool _playerStands;
    private Timer _timer;
    private int totalTime = 60;

    public Guid PlayerId = Guid.NewGuid();
    public List<BlackJackCard> PlayerCards = new();
    public int PlayerBalance = 0;
    
    public Guid DealerId { get; set; } = Guid.NewGuid();
    public List<BlackJackCard> DealerCards = new();
    
    public string Message { get; set; }
    public int BetSize { get; set; } = 1;
    public ICardStyle CardsStyle { get; set; }

    protected override async Task OnInitializedAsync()
    {
        CardsStyle = _style.CreateCardsStyle();
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/blackjackhub"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On("UpdatePlayer", () =>
        {
            InvokeAsync(StateHasChanged);
        });
        _hubConnection.On<Guid, int>("NewPlayerJoined", NewPlayerJoined);
        _hubConnection.On("BettingPhaseStarted", () =>
        {
            Message = "Betting ends in: 60 seconds";
            RunTimer();
        });
        _hubConnection.On("BettingPhaseDone", async () =>
        {
            Message = "Betting done!";

            await InvokeAsync(StateHasChanged);
        });
        _hubConnection.On("InitialDealPhase", () => Message = "Dealing cards..");
        _hubConnection.On("InitialDealPhaseOver", async () =>
        {
            Message = "Initial dealing phase is over";
            _hidePlayButtons = false;
            _initialPhaseDone = true;
            await InvokeAsync(StateHasChanged);
        });
        _hubConnection.On<Guid, Card>("CardDealt", async (playerId, card) =>
        {
            // if (card is null)
            //     return;
            //
            // if (playerId.Equals("Dealer"))
            // {
            //     Dealer.Cards.Add(card);
            //     Message = "";
            // }
            // else
            // {
            //     BlackJackPlayer.Cards.Add(card);
            //     Message = "";
            //     if (_initialPhaseDone && !_hidePlayButtons)
            //     {
            //         await _hubConnection.SendAsync("DrawCard", "Dealer");
            //         Message = "Dealer drawing card";
            //     }
            // }
            // CheckWinner(Dealer.Cards.Sum(c => c.ScoreValue), BlackJackPlayer.Cards.Sum(c => c.ScoreValue));
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On("BettingPhaseDone" , () =>
        {
            Message = "Betting finished. Dealer drawing cards";
        });
        
        await _hubConnection.StartAsync();
        Console.WriteLine("Connection established");

        await InvokeAsync(StateHasChanged);
    }

    private void Payouts()
    {
        // BlackJackPlayer.Balance += (int)(BlackJackPlayer.Bet * 1.5);
    }
    
    private void CheckWinner(int dealerScore, int playerScore)
    {
        switch (dealerScore)
        {
            case 21:
                _hidePlayButtons = true;
                Message = "BLACKJACK! House wins!";
                SetupRestartButton();
                break;
            case > 21:
                _hidePlayButtons = true;
                Message = "You won";
                SetupRestartButton();
                Payouts();
                break;
            case < 21:
                _loading = false;
                break;
        }
        switch (playerScore)
        {
            case 21:
                _hidePlayButtons = true;
                Message = "BLACKJACK! You win!";
                SetupRestartButton();
                Payouts();
                break;
            case > 21:
                _hidePlayButtons = true;
                Message = "House wins";
                SetupRestartButton();
                break;
            case < 21:
                _loading = false;
                break;
        }
        if (!_playerStands) return;
        if (dealerScore > playerScore)
        {
            Message = "House wins";
            SetupRestartButton();
        }
        else if (dealerScore < playerScore)
        {
            Message = "Player wins";
            SetupRestartButton();
            Payouts();
        }
        else
        {
            Message = "Draw!";
            SetupRestartButton();
            // BlackJackPlayer.Balance += BlackJackPlayer.Bet;
        }
    }

    private void SetupRestartButton()
    {
        StartBtnLabel = "Restart game";
        _hideStartGameBtn = false;
    }

    private async Task JoinTable()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.SendAsync("PlayerJoined", _playerId, _tableId);
            _hideJoinButton = true;
        }
    }

    private async Task NewPlayerJoined(Guid playerId, int balance)
    {
        Console.WriteLine($"New player joined {playerId} with balance {balance}");
        _hideStartGameBtn = false;

        await InvokeAsync(StateHasChanged);
    }

    private async Task Bet()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.SendAsync("PlayerBet", PlayerId, BetSize);
            _hideStartGameBtn = true;
            _hideTable = false;
            
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task ChangeCardsStyle()
    {
        if (typeof(DefaultStyle) == _style.GetType())
        {
            _style = new RedStyle();
            CardsStyle = _style.CreateCardsStyle();
        }
        else if (typeof(RedStyle) == _style.GetType())
        {
            _style = new BlueStyle();
            CardsStyle = _style.CreateCardsStyle();
        }
        else if (typeof(BlueStyle) == _style.GetType())
        {
            _style = new DefaultStyle();
            CardsStyle = _style.CreateCardsStyle();
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task DrawCard()
    {
        if (_hubConnection != null)
        {
            await _hubConnection.SendAsync("DrawCard", PlayerId.ToString());
            Message = "Drawing card..";
            _loading = true;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task PlayerStands()
    {
        if (_hubConnection != null)
        {
            await _hubConnection.SendAsync("DrawCard", "Dealer");

            _playerStands = true;
            _loading = true;
            Message = "You stand!";
            
            await InvokeAsync(StateHasChanged);
        }
    }

    private void Reset()
    {
        DealerCards = new List<BlackJackCard>();
        PlayerCards = new List<BlackJackCard>();
    }

    private void RunTimer()
    {
        _timer = new Timer(OnTimerElapsed, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private async void OnTimerElapsed(object? state)
    {
        totalTime--;
        Message = $"Betting ends in: {totalTime} seconds";

        if (totalTime <= 0)
        {
            Message = "Betting finished";
            await _timer.DisposeAsync();
        }

        await InvokeAsync(StateHasChanged);
    }

} 